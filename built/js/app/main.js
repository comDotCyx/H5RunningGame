define(["lib/zepto_amd.min","app/gameConfig","app/movers","app/player","app/collision","app/touch","lib/gameFunctions","lib/localStorage","lib/zepto.imgpreload"],function(e,t,n,r,i,s,o,u,a){function ht(){var e=Z.canPlayType("audio/mp3"),t=Z.canPlayType("audio/ogg");return!!e&&"0"||!!t&&"1"}function pt(){st=ht();if(!st){alert("当前浏览器不支持播放音乐"),it.hide();return}it.on("click",function(){et===!1?(Z.play(),et=!0,Z.pause(),tt=!1,Z.src=nt[st],Z.load(),rt=setInterval(function(){/UCBrowser/.test(navigator.userAgent)&&(tt=!0),Z.readyState>3&&tt&&(clearInterval(rt),Z.play(),it.addClass("playing").removeClass("paused"))},500)):it.hasClass("playing")?(Z.pause(),it.addClass("paused").removeClass("playing")):(it.addClass("playing").removeClass("paused"),Z.play())})}function dt(){ft=e("#endTipBg"),ft.on("click",".closeTipBtn",function(){ft.hide(),ft.find(".tipBox").addClass("hideBox"),e(this).hasClass("againBtn")?yt():e(this).hasClass("recordBtn")&&vt("#game")}),J=t(),K=J.getAllPics(),gt(K)}function vt(t){var n=lt.attr("data-upted");(!n||n!=="yes")&&mt(),e(t).hide(),lt.show()}function mt(){lt.find(".times").html(ut.times),lt.find(".best").html(ut.best),lt.find(".worst").html(ut.worst),lt.find(".totalDistance").html(ut.total);var e="",t=ut.topList;for(var n=0;n<t.length;n++){var r=xt(new Date(t[n].date*1));e+='<li><div class="num">'+(n+1)+'</div><div class="grade">'+t[n].grade+"m"+'</div><div class="date">'+r+"</div></li>"}lt.find(".topList").html(e),lt.attr("data-upted","yes")}function gt(t){e.preloadImg(["../images/loading-1.gif","../images/loading-2.gif","../images/loading-3.gif"],{each:function(e){},all:function(){var n=t.length;e.preloadImg(t,{each:function(t){var r=t;l=(r/n*100).toFixed(),l>33&&l<66?e("#progressAnimPic").attr("src","../images/loading-2.gif"):l>66&&e("#progressAnimPic").attr("src","../images/loading-3.gif"),e("#progressAnimPic").css("left",l+"%"),e("#progressMsk").css("width",100-l+"%"),e("#porgressNum").html("已加载"+l+"%")},all:function(){console.log("游戏图片加载完毕"),e("#loadingPage").hide(),e("#game").show(),yt(!0)}})}})}function yt(t){L=0,v=0,A=P,C=Date.now(),d=0,F=0,j=0,R=5,c=0,e(p).attr("src",h[0]),D=!1;if(t===!0){O=document.getElementById("countT"),B=document.getElementById("distance"),_=document.getElementById("reduce"),I=document.getElementById("cheerTip"),p=document.getElementById("timeImg");var i=J.canvas;m=i.can1.el,g=i.can1.ctx,y=i.can2.el,b=i.can2.ctx,w=i.can3.el,E=i.can3.ctx,S=i.can4.el,x=i.can4.ctx,H=n.perspective,T=m.width,N=m.height,canH4=S.height,b.translate(T*.5,N-H),E.translate(T*.5,N-H),x.translate(T*.5,canH4-H),q=["快快快，不要像个老太太！","加油！加油！加油！","喔，不错哦！","你跑得像风一样快","保持住！胜利就在眼前！"],I.innerHTML=q[0],h=["../images/time-3.png","../images/time-2.png","../images/time-1.png","../images/time-go.png"],e(p).attr("src",h[0]),Y=[{tip:"-5s",reduceTime:5e3},{tip:"-3s",reduceTime:3e3}],Et(),G=J.playerObject[0].config,z=new r(G),z.init(),$=s(z),y.addEventListener("touchstart",$.touchStart,!0),y.addEventListener("touchmove",$.touchMove,!0),y.addEventListener("touchend",$.touchEnd),e("#guide").on("click",function(){e(this).find(".guideImg").hide(),e(this).find(".timeCount").show(),setTimeout(St,1e3)})}else X.forEach(function(e){e.deadAll()}),W.deadAll(),e("#guide").show(),e(this).find(".timeCount").show(),setTimeout(St,1e3);z.side=0,O.innerHTML=A,B.innerHTML="0m",Q=J.moveObjects,V=Q.length;for(var o=0;o<V-1;o++)X[o]=new n(Q[o].config),X[o].init();requestAnimFrame(bt)}function bt(){var t=Date.now();k=t-C,C=t,k>40&&(k=40),b.clearRect(-0.5*T,H-N,T,N),E.clearRect(-0.5*T,H-N,T,N),x.clearRect(-0.5*T,H-canH4,T,canH4);for(var r=0;r<V-1;r++)X[r].Monitor(k),X[r].draw(k);if(D){L+=k,v+=k,A=P-Math.floor((L+d)/1e3),F=Number((j+v/1e3*R).toFixed(2)),B.innerHTML=F+"m";if(A<=0){A=0,O.innerHTML="0",console.log("游戏结束"),wt(),D=!1;return}O.innerHTML=A,W.Monitor(k),i(W,z,function(t){if(isNaN(Number(t))||typeof Y[t]=="undefined")return;d+=Y[t].reduceTime,_.innerHTML=Y[t].tip,e(_).show(),setTimeout(function(){e(_).hide()},1e3)}),n.primeSpd<=1.2&&v>3e3&&(j+=v/1e3*R,R++,v=0,n.primeSpd+=.07,n.decrecedInterval=Math.min(n.decrecedInterval+60,520),X.forEach(function(e){e.update()}),W.update());var s=Math.min(Math.floor(L/1e4),4);I.innerHTML=q[s]}z.draw(b,40,k),D&&W.draw(k),requestAnimationFrame(bt)}function wt(){e("#curGrade").html(F+"米"),lt.attr("data-upted","no");var t=ut.topList.length,n=ut.topList[t-1],r=+(new Date),i=ut.total+F,s=ut.times+1,o=ut.worst,u=ut.best,a;if(t<10||F>n.grade){if(t===0)a=0;else for(var f=t-1;f>=0;f--){if(!(F>ut.topList[f].grade)){a=f+1;break}if(f>0)continue;a=0}ut.topList.splice(a,0,{date:r,grade:F})}ut.total=Number(i.toFixed(2)),ut.times=s,(!o||F<o)&&(ut.worst=F),F>u&&(ut.best=F),ut.topList.length>10&&ut.topList.splice(10),console.log(ut),at.setItem({key:"myH5RunningGame",value:ut}),ct.find(".recordBtn").show(),ft.show(),setTimeout(function(){ft.find(".tipBox").removeClass("hideBox")},10)}function Et(){var e=new Image,t=new Image;e.onload=function(){g.drawImage(e,0,0),t.src=J.background[0].config.picSource[1]},t.onload=function(){g.drawImage(t,0,149)},e.src=J.background[0].config.picSource[0]}function St(){c++;if(c<4){switch(c){case 1:timeImg="../images/time-2.png";break;case 2:timeImg="../images/time-1.png";break;case 3:timeImg="../images/time-go.png"}e(p).attr("src",h[c]),setTimeout(St,1e3)}else D=!0,W=new n(Q[V-1].config),W.init(),e("#guide").css("display","none")}function xt(e){var t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate(),i=""+t+"/"+n+"/"+r+" ",s=e.getHours(),o=e.getMinutes();o=o<10?"0"+o:""+o;var u=e.getSeconds();return u=u<10?"0"+u:""+u,i+=s+":"+o+":"+u,i}function Tt(){f?(e("#game").show(),yt()):(f=!0,e("#loadingPage").show(),dt())}var f=!1,l,c,h=[],p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P=60,H,B,j,F,I,q,R,U,z,W,X=[],V,$,J,K,Q,G,Y,Z=new Audio;Z.loop=!0;var et=!1,tt=!1,nt=["../media/bgm1.mp3","../media/bgm1.ogg"],rt=null,it=e("#bgmBtn"),st;Z.addEventListener("canplaythrough",function(){tt=!0}),Z.addEventListener("error",function(){rt&&clearInterval(rt),alert("背景音乐加载失败"),it.addClass("paused").removeClass("playing"),tt=!1,et=!1});var ot,ut,at,ft,lt=e("#record"),ct=e("#cover");e(function(){e("#guidTipsBtn").on("click",function(){e("#guidTipsBox").toggleClass("hideBox")}),e(".closeTipBtn").on("click",function(){e(this).parent(".tipBoxBg").hide(),e(this).parent(".tipBox").addClass("hideBox")}),pt(),ct.on("click",".recordBtn",function(){ct.find(".tipBox").addClass("hideBox"),vt("#cover")}),at=u(),at.isSupportLs&&(ut=at.getItem("myH5RunningGame"),ut?ct.find(".recordBtn").show():ut={topList:[],total:0,times:0,best:0,worst:0},console.log(ut)),ct.on("click",".runningBtn",function(){ct.hide(),ct.find(".tipBox").addClass("hideBox"),Tt()}),lt.on("click",".goPlay",function(){lt.hide(),Tt()}),lt.on("click",".goBack",function(){lt.hide(),ct.show()})})});